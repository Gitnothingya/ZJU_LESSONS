- 内核源码下载

https://github.com/raspberrypi/linux

查看rpi的内核版本：

```shell
uname -a
```

==一定要下载内核版本相同的==

版本为6.1.21-v7+



- 安装arm32交叉编译环境

要在Ubuntu上安装ARM32交叉编译环境，您需要执行以下步骤：

1. 安装交叉编译工具链

打开终端并运行以下命令：

```shell
sudo apt-get update
sudo apt-get install gcc-arm-linux-gnueabihf
```

这将安装ARM32交叉编译器（gcc-arm-linux-gnueabihf）和相关工具。

2. 设置环境变量

在终端中输入以下命令以设置交叉编译工具链的环境变量：

```shell
export CC=arm-linux-gnueabihf-gcc
export CXX=arm-linux-gnueabihf-g++
```

这将使系统使用正确的编译器进行ARM32交叉编译。

3. 测试工具链

现在您可以尝试编译一个简单的程序，以确保工具链已经正确安装并设置。例如，您可以创建一个名为“helloworld.c”的文件，其中包含以下内容：

```c
#include <stdio.h>
int main()
{
    printf("Hello, world!\n");
    return 0;
}
```

在终端中运行以下命令以编译程序：

```shell
$CC -o helloworld helloworld.c
```

这将使用ARM32交叉编译器编译程序。您可以运行以下命令以在ARM32平台上测试该程序：

```shell
qemu-arm -L /usr/arm-linux-gnueabihf ./helloworld
```

如果您看到“Hello, world！”的输出，则说明工具链已经正确安装并设置。

希望这可以帮助您安装ARM32交叉编译环境。



- 官方提供的交叉编译工具

[raspberrypi/tools (github.com)](https://github.com/raspberrypi/tools)

[(21条消息) 【树莓派】交叉编译环境搭建_树莓派交叉编译环境搭建_pkufenghao的博客-CSDN博客](https://blog.csdn.net/iefenghao/article/details/88815093)



- 编译内核

是的，如果您只是编译内核镜像而不需要在本地安装内核，则可以跳过安装内核的步骤。

在交叉编译内核时，您需要为目标架构设置交叉编译工具链，并使用该工具链来编译内核代码。以下是一些基本步骤：

1. 安装交叉编译工具链

在您的本地计算机上安装适用于目标架构的交叉编译工具链。您可以使用以下命令安装ARM架构的交叉编译工具链：

```
sudo apt-get update
sudo apt-get install gcc-arm-linux-gnueabihf
```

2. 设置交叉编译环境变量

在终端中输入以下命令以设置交叉编译工具链的环境变量：

```
export CROSS_COMPILE=arm-linux-gnueabihf-
```

这将使系统使用正确的编译器进行ARM交叉编译。

3. 配置内核

进入内核源代码目录并运行以下命令以开始配置内核：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- <target_defconfig>
```

此命令将使用指定的目标默认配置文件开始配置内核。

4. 编译内核

在完成配置后，您可以使用以下命令编译内核：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf-
```

此命令将使用交叉编译器编译内核代码。

5. 生成内核镜像

完成编译后，您可以使用以下命令生成内核镜像文件：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage
```

此命令将生成一个名为“zImage”的内核镜像文件。

这些是编译ARM架构内核的基本步骤。如果您需要更详细的信息或指导，请参阅内核源代码中的文档或官方文档。



- 可以参考rk板的步骤

[1. Kernel 使用 — Firefly Wiki (t-firefly.com)](https://wiki.t-firefly.com/zh_CN/ROC-RK3568-PC-SE/kernel_introduction.html)



- 简单参考

[树莓派3b 编译内核之交叉编译 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/496977796)





- 内核配置

在树莓派内核源码中，defconfig文件通常位于arch/arm/configs目录下。这个目录包含了一系列默认的内核配置文件，可以用来为不同的硬件平台和设备生成内核配置。

要使用其中的一个defconfig文件来生成内核配置，您可以在内核源码目录下运行以下命令：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- <target_defconfig>
```

其中，`<target_defconfig>`是您所选择的defconfig文件的名称。例如，如果您要使用树莓派3B的defconfig文件进行编译，可以运行以下命令：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcm2709_defconfig
```

这个命令将使用bcm2709_defconfig文件来生成内核配置。在生成配置后，您可以使用`make menuconfig`命令来进一步编辑和调整内核配置选项。完成配置后，您可以使用`make`命令来编译内核。

请注意，为了使用交叉编译工具链进行编译，您需要先安装适当的工具链，并将其添加到系统路径中。在本例中，我们使用了arm-linux-gnueabihf-作为交叉编译工具链的前缀。如果您的系统上没有安装这个工具链，请先安装它，并将其添加到系统路径中。

在内核根目录(不需要进入kernel目录)：

```shell
export CROSS_COMPILE=arm-linux-gnueabihf-

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcm2709_defconfig

make ARCH=arm menuconfig

make ARCH=arm savedefconfig
mv defconfig arch/arm/configs/bcm2709_defconfig
```

开始编译

```shell
make
```



# 成功

==好像不太行，配置有点麻烦，看这个教程：==

[树莓派3b 编译内核之交叉编译 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/496977796)

树莓派环境下：获取内核配置文件

```bash
sudo modprobe configs
```

在树莓派文件系统/proc目录下，将config.gz文件拷贝到Ubuntu环境下。注意将其权限改为777，否则sftp里看不到。

然后linux-rpi-6.1.y/ 执行以下操作：

```bash
zcat config.gz > .config
```

然后使用如下命令开始编译(仅编译内核和==内核模块==)：

```shell
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage modules
```

必须要编译内核模块，此过程会自动生成scripts/module.lds，后面编译自己写的模块要用

















是的，当您运行'make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage modules'命令时，内核源代码会按照以下步骤编译内核模块：

1. 编译模块的源代码，生成目标代码（.o文件）。

2. 将目标代码链接成动态链接库（.ko文件）。

在这个过程中，内核源代码会生成一些中间文件，例如.mod、.o等文件。这些中间文件是编译过程的临时文件，用于描述模块的元数据和依赖关系，以及链接模块的目标代码。

首先，内核源代码会编译模块的源代码，生成目标代码（.o文件）。这些目标代码包含了模块的函数和变量定义，但还没有链接到动态链接库中。

然后，内核源代码会将这些目标代码链接成动态链接库（.ko文件）。在这个过程中，内核源代码会使用.mod文件来描述模块的元数据和依赖关系，然后将目标代码链接到动态链接库中。

最终，内核源代码会生成一个或多个.ko文件，这些文件包含了模块的所有代码和数据，可以在内核运行时动态加载和卸载。

需要注意的是，生成的.mod、.o、.ko等中间文件通常是编译过程的临时文件，可以在编译完成后进行清理。您可以使用'make clean'命令来清理内核源代码中的中间文件和目标文件，以释放存储空间。















非常抱歉，我的回答可能存在误解。确实，`make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- oldconfig` 命令只会加载之前的内核配置文件，更新配置文件中缺失的选项，并不会开始编译内核。如果您需要开始编译内核，==可以使用以下命令：==

```shell
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage
```

这个命令会编译内核并生成zImage文件。如果需要编译其他内核模块，可以使用以下命令：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules
```

这个命令会编译所有内核模块，并生成ko文件。如果您需要同时编译内核和内核模块，可以使用以下命令：

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- all
```

这个命令会编译内核和内核模块，并生成zImage和ko文件。请注意，编译内核需要一定的时间和计算资源，具体时间取决于您的计算机性能和内核代码大小。