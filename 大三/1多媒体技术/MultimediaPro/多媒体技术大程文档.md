# 多媒体技术大程文档

## 图像存储原理











## 编码标准

* 10/9?   个必须的的段

#### 段结构

```
-----------------------------------------------------------------
名称  字节数     数据  说明
-----------------------------------------------------------------
段标识   1         FF      每个新段的开始标识
段类型   1                 类型编码（称作“标记码”）
段长度   2                 包括段内容和段长度本身,不包括段标识和段类型
段内容                     ≤65533字节
```

#### 段类型

```
段类型   表示符号      说明
——————————————————————————————————
SOI      D8          文件头
​
APP0     E0          定义交换格式和图像识别信息

​
DQT      DB          定义量化表
​
SOF0     C0          图像基本信息

​
DHT      C4          定义 Huffman 表（霍夫曼表）
DRI      DD          定义重新开始间隔（非必须？）
SOS      DA          扫描行开始
COM      FE          注释（非必须？）
EOI      D9          文件尾
......
```

* `APPn` 和`SOFn`（n = 1~15）可以忽略

#### 文件头SOI

* 写入`FFD8`即可

#### APP0

```
--------------------------------------------------------------------------
名称      字节数     值                   说明
--------------------------------------------------------------------------
段标识       1         FF
段类型       1         E0
段长度       2         0010                    如果有RGB缩略图就＝16＋3n
　　（以下为段内容）
交换格式      5         4A46494600          “JFIF”的ASCII码
主版本号      1
次版本号      1  
密度单位      1         0＝无单位；1＝点数/英寸；2＝点数/厘米
X像素密度     2                             水平方向的密度   
Y像素密度     2                             垂直方向的密度
缩略图X像素  1                           缩略图水平像素数目  
缩略图Y像素  1                           缩略图垂直像素数目
（如果“缩略图X像素”和“缩略图Y像素”的值均＞0，那么才有下面的数据）
RGB缩略图  3×n         n＝缩略图像素总数＝缩略图X像素×缩略图Y像素
--------------------------------------------------------------------------
```

* 应该通常没有缩略图……
* 写入`ff e0 / 00 10 /4a 46 49 46 00 /01 /01 /00 /00 01 /00 01 /00 00`

#### 量化表DQT

```
--------------------------------------------------------------------------
名称  字节数 值       说明
--------------------------------------------------------------------------
段标识   1     FF
段类型   1     DB
段长度   2     43      其值＝3＋n（当只有一个QT时）
（以下为段内容）
QT信息  1     		0－3位：QT号 取值0~3？
					4－7位：QT精度（0＝8bit，1字节；否则＝16bit，2字节）即几个字节表示一个量化系数
QT        n             n＝64×QT精度的字节数
--------------------------------------------------------------------------
```

* 通常是两张表，即两个`FF DB`，貌似还有一个`FF DB`表示的一张表？长度为`0x00 84  (132)`即(2 + 64)*2，都是亮度后色度？

* 按通常表示，即写入两组`FF DB  00 43 ...`，表应该是逐行写入？

* 亮度量化表

* ```
  [ 16, 11, 10, 16, 24,  40,  51,  61,
    12, 12, 14, 19, 26,  58,  60,  55,
    14, 13, 16, 24, 40,  57,  69,  56,
    14, 17, 22, 29, 51,  87,  80,  62,
    18, 22, 37, 56, 68,  109, 103, 77,
    24, 35, 55, 64, 81,  104, 113, 92,
    49, 64, 78, 87, 103, 121, 120, 101,
    72, 92, 95, 98, 112, 100, 103, 99]
  ```

* 色度量化表

* ```
  [ 17, 18, 24, 47, 99, 99, 99, 99,
    18, 21, 26, 66, 99, 99, 99, 99,
    24, 26, 56, 99, 99, 99, 99, 99,
    47, 66, 99, 99, 99, 99, 99, 99,
    99, 99, 99, 99, 99, 99, 99, 99,
    99, 99, 99, 99, 99, 99, 99, 99,
    99, 99, 99, 99, 99, 99, 99, 99,
    99, 99, 99, 99, 99, 99, 99, 99]
  ```



#### SOF0图像基本信息

```
--------------------------------------------------------------------------
名称  字节数 值       说明
--------------------------------------------------------------------------
段标识   1     FF
段类型   1     C0
段长度   2             其值＝8＋组件数量×3
　　（以下为段内容）
样本精度 1      8       每个样本位数（大多数软件不支持12和16）
图片高度 2
图片宽度 2
组件数量 1      3       1＝灰度图，3＝YCbCr/YIQ 彩色图，4＝CMYK 彩色图
　　（以下每个组件占用３字节）
组件 ID     		1        1＝Y, 2＝Cb, 3＝Cr, 4＝I, 5＝Q
采样系数 1              0－3位：垂直采样系数
                        4－7位：水平采样系数
量化表号 1
---------------------------------------------------------------------------
```



* 基本为固定序列：段长（8+3*3= 0x11）；组件为`YCbCr`，除了图片的高度和宽度需要自行测定，采样系数应该也自定义。

* 对于组件序列 `01 22 00 02 11 01 03 11 01`

  * 01 22 00 => Y组件，垂直采样系数和水平采样系数都是2，量化表号是0
  * 02 11 01 => Cb组件，垂直采样系数和水平采样系数都是1，量化表号是1
  * 03 11 01 => Cr组件，垂直采样系数和水平采样系数都是1，量化表号是1

  * //此处可知此处Y采样是逐点采样，CbCr都是隔点采样，这就是标准的YUV422的数据。

* 写入`ff c0 00 11 08 高度 宽度 03 组件... `

#### DHT 定义霍夫曼表

```
--------------------------------------------------------------------------
名称  字节数    值       说明
--------------------------------------------------------------------------
段标识   1     FF
段类型   1     C4
段长度   2                其值＝19＋n（当只有一个HT表时）
　　（以下为段内容）
HT信息  1                 0－3位：HT号
                          4位：   HT类型, 0＝DC表，1＝AC表
　　　　　　　　　　       5－7位：必须＝0
HT位表  16                这16个数的和应该≤256
HT值表  n                 n＝表头16个数的和
--------------------------------------------------------------------------
```

```python
# 标准霍夫曼表
00 01 05 01 01 01 01 01 01 00 00 00 00 00 00 00 
00 01 02 03 04 05 06 07 08 09 0a 0b




00 02 01 03 03 02 04 03 05 05 04 04 00 00 01 7d

01 02 03 00 04 11 05 12 21 31 41 06 13 51 61 07
22 71 14 32 81 91 a1 08 23 42 b1 c1 15 52 d1 f0
24 33 62 72 82 09 0a 16 17 18 19 1a 25 26 27 28
29 2a 34 35 36 37 38 39 3a 43 44 45 46 47 48 49
4a 53 54 55 56 57 58 59 5a 63 64 65 66 67 68 69
6a 73 74 75 76 77 78 79 7a 83 84 85 86 87 88 89
8a 92 93 94 95 96 97 98 99 9a a2 a3 a4 a5 a6 a7
a8 a9 aa b2 b3 b4 b5 b6 b7 b8 b9 ba c2 c3 c4 c5
c6 c7 c8 c9 ca d2 d3 d4 d5 d6 d7 d8 d9 da e1 e2
e3 e4 e5 e6 e7 e8 e9 ea f1 f2 f3 f4 f5 f6 f7 f8
f9 fa

00 03 01 01 01 01 01 01 01 01 01 00 00 00 00 00
00 01 02 03 04 05 06 07 08 09 0a 0b



```

#### SOS

```
--------------------------------------------------------------------------
名称          字节数 值       说明
--------------------------------------------------------------------------
段标识            1    FF
段类型            1    DA
段长度            2    000C    其值＝6＋2×扫描行内组件数量
　　（以下为段内容）
扫描行内组件数量 1  3       必须≥1，≤4（否则错误），通常＝3
　　（以下每个组件占用２字节）
组件ID               1    1 = Y, 2 = Cb, 3 = Cr, 4 = I, 5 = Q
Huffman表号      1    0－3位：AC表号 (其值＝0...3)
                                    4－7位：DC表号(其值＝0...3)
剩余3个字节          3           最后３个字节用途不明，忽略
--------------------------------------------------------------------------

```



#### 结束 EOI

```
------------------
名称  字节数   值
------------------
段标识   1     FF
段类型   1     D9 
------------------
```







#### 项目结构

```
main.py
仅提供菜单功能，调用压缩和解压缩两个函数

const.py 定义常量 
dct变换矩阵
亮度量化，色度量化
zig,zag编码表






```



# 像素编码细节

* 每4个块一处理(16 \* 16)，开始填充时将图像填充成高和宽都为16的倍数（采样系数`4:2:0`，要保证都可分成8\*8的块），输出顺序（`Y Y Y Y Cb Cr`）
* jpeg压缩中计算像素值采用变长反码，编码长度为正数的最大有效位数，例如`12 = 1 0100,-12 =0 1011`
* 单个块存储，注意亮度和色度的DC和AC码表不同
  * DC编码，首先根据DC差值码表存储DC值的长度，后跟DC的差值
  * AC编码，游程编码，实际分为两段，一段为频率和幅值长度的霍夫曼编码，后跟幅值的编码`(6,3)->(6,2),b11`，0x62通过标准霍夫曼表查询编码，后跟11



[JPEG编码过程详解 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/626160823#:~:text=对于JPEG标准,后续处理的要求。)



## 参考

[深入浅出JPEG|极客笔记 (deepinout.com)](https://deepinout.com/camera-terms/easy-to-understand-jpeg.html#ftoc-heading-9)