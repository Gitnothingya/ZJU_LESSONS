<h1 align = "center">实验3 SQL数据完整性</h1>

**实验目的：**

1. 熟悉通过SQL进行数据完整性控制的方法。

**实验平台：**

1. 数据库管理系统：MySQL

**实验内容和要求：**

1. 定义若干表，其中包括primary key,foreign key和check的定义。

2. 让表中插入数据，考察primary key如何控制实体完整性。

3. 删除被引用表中的行，考察foreign key中on delete子句如何控制参照完整性。

4. 修改被引用表中的行的primary key，考察foreign key中on update子句如何控制参照完整性。

5. 修改或插入表中数据，考察check子句如何控制校验完整性。

6. 定义一个assertion,并通过修改表中数据考察断言如何控制数据完整性。

7. 定义一个trigger,并通过修改表中数据考察触发器如何起作用。

**实验过程：**

1. 建立多个新表，包含主键与外键。

```sql
create table department
	(dept_name		varchar(20), 
	 building		varchar(15), 
	 budget		        numeric(12,2) check (budget > 0),
	 primary key (dept_name)
	);
create table student
	(ID			varchar(5), 
	 name			varchar(20) not null, 
	 dept_name		varchar(20), 
	 primary key (ID),
	 foreign key (dept_name) references department (dept_name)
	);
#注意表的建立顺序，由于student参照了department，必须先建立department。
```

2. 向表中插入数据，

```sql
insert into department values ('Finance', 'Painter', '120000');
insert into department values ('History', 'Painter', '50000');
insert into department values ('Music', 'Packard', '80000');
insert into department values ('Physics', 'Watson', '70000');
```

![image-20220405211015907](image/image-20220405211015907.png)

​	再插入重复主键的记录。

```sql
insert into department values ('Physics', 'Newyo', '90000');
```

​	出现错误信息。

![image-20220405211210591](image/image-20220405211210591.png)

<font color='red'>21:11:34	insert into department values ('Physics', 'Newyo', '90000')	Error Code: 1062. Duplicate entry 'Physics' for key 'department.PRIMARY'	0.000 sec</font>

3. 删除被引用表中的行，考察foreign key 中on delete 子句如何控制参照完整性。

   首先向student表中插入一条记录。

```sql
insert into student values ('22001', 'Brandt', 'History');
```

![image-20220405211752420](image/image-20220405211752420.png)

​	然后删除 'History' 这个系。发现报错（已提前关闭安全模式）。

```sql
Delete from department where dept_name = 'History';
```

![image-20220405212042983](image/image-20220405212042983.png)

<font color='red'>21:20:25	Delete from department where dept_name = 'History'	Error Code: 1451. Cannot delete or update a parent row: a foreign key constraint fails (`testyh`.`student`, CONSTRAINT `student_ibfk_1` FOREIGN KEY (`dept_name`) REFERENCES `department` (`dept_name`))	0.015 sec</font>

4. 修改被引用表中的行的primary key，考察foreign key 中on update 子句如何控制参照完整性。

```sql
update department 
set dept_name = 'Math'
where building = 'Painter';
```

​	出现错误信息。

<font color='red'>21:25:59	update department  set dept_name = 'Math' where building = 'Painter'	Error Code: 1451. Cannot delete or update a parent row: a foreign key constraint fails (`testyh`.`student`, CONSTRAINT `student_ibfk_1` FOREIGN KEY (`dept_name`) REFERENCES `department` (`dept_name`))  0.015 sec</font>

5. 修改或插入表中数据，考察check子句如何控制校验完整性。

```sql
insert into department values ('Math', 'Nothing', '-8888');
```

报错信息：

<font color='red'>21:29:23	insert into department values ('Math', 'Nothing', '-8888')	Error Code: 3819. Check constraint 'department_chk_1' is violated.	0.000 sec</font>

6. 定义一个assertion , 并通过修改表中数据考察断言如何控制数据完整性。

```sql
Create assertion money 
check
(not exists (select * from department
Where budget>80000));
```

​	MySQL 不支持断言，无法执行，报错。

![image-20220405213704042](image/image-20220405213704042.png)

7.  定义一个trigger, 并通过修改表中数据考察触发器如何起作用。

   原先表department：

![image-20220405214212362](image/image-20220405214212362.png)

​		原先表student：

![image-20220405214151775](image/image-20220405214151775.png)

```sql
#建立触发器
Delimiter $$
Create trigger changemajor
	After update on department
	For each row 
Begin
	Update student set dept_name = 'Music'
	where student.name ='Garze';
end;$$
Delimiter ;

#更新department
update department
set budget = '50000';
where dept_name = 'Physics';
```

更新后department的数据：

![image-20220405220003601](image/image-20220405220003601.png)

更新后student的数据：

![image-20220405215910316](image/image-20220405215910316.png)

